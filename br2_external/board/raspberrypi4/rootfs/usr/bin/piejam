#!/bin/sh

cd /piejam
export HOME=/piejam

dsi_connected=false
hdmi_connected=false

for dsi in /sys/class/drm/card*-DSI-*; do
    # Check if touchscreen input exists (DSI physically present)
    if grep -q -E "ft5x06|Goodix" /sys/class/input/event*/device/name 2>/dev/null; then
        dsi_base="$(basename "$dsi")"
        dsi_card="${dsi_base%%-*}"
        dsi_connector="${dsi_base#*-}"
        dsi_connected=true
        break
    fi
done

# Check HDMI connectors for real "connected" status
for hdmi in /sys/class/drm/card*-HDMI-A-*; do
    if [[ -f "$hdmi/status" ]] && grep -q "connected" "$hdmi/status"; then
        hdmi_base="$(basename "$hdmi")"
        hdmi_card="${hdmi_base%%-*}"
        hdmi_connector="${hdmi_base#*-}"
        hdmi_connected=true
        break
    fi
done

if $dsi_connected || $hdmi_connected; then

    if $dsi_connected; then
        card="$dsi_card"
        connector="$dsi_connector"
    elif $hdmi_connected; then
        card="$hdmi_card"
        connector="$hdmi_connector"
    fi

# Generate eglfs config
cat > /piejam/eglfs.json <<EOF
{
    "device": "/dev/dri/$card",
    "hwcursor": false,
    "outputs": [
        { "name": "$connector", "primary": true }
    ]
}
EOF

    export QT_QPA_EGLFS_KMS_CONFIG=/piejam/eglfs.json

    /usr/bin/piejam_app
fi

/sbin/halt
