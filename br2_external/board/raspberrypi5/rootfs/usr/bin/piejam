#!/bin/sh

cd /piejam
export HOME=/piejam

DSI_CONNECTED=false
HDMI_CONNECTED=false

for dsi in /sys/class/drm/card*-DSI-*; do
    # Check if touchscreen input exists (DSI physically present)
    if grep -q -E "ft5x06|Goodix" /sys/class/input/event*/device/name 2>/dev/null; then
        DSI_BASE="$(basename "$dsi")"
        DSI_CARD="${DSI_BASE%%-*}"
        DSI_CONNECTOR="${DSI_BASE#*-}"
        DSI_CONNECTED=true
        break
    fi
done

# Check HDMI connectors for real "connected" status
for hdmi in /sys/class/drm/card*-HDMI-A-*; do
    if [[ -f "$hdmi/status" ]] && grep -q "connected" "$hdmi/status"; then
        HDMI_BASE="$(basename "$hdmi")"
        HDMI_CARD="${HDMI_BASE%%-*}"
        HDMI_CONNECTOR="${HDMI_BASE#*-}"
        HDMI_CONNECTED=true
        break
    fi
done

if $DSI_CONNECTED || $HDMI_CONNECTED; then

    if $DSI_CONNECTED; then
        CARD="$DSI_CARD"
        CONNECTOR="$DSI_CONNECTOR"
    elif $HDMI_CONNECTED; then
        CARD="$HDMI_CARD"
        CONNECTOR="$HDMI_CONNECTOR"
    fi

# Generate eglfs config
cat > /piejam/eglfs.json <<EOF
{
    "device": "/dev/dri/$CARD",
    "hwcursor": false,
    "outputs": [
        { "name": "$CONNECTOR", "primary": true }
    ]
}
EOF

    export QT_QPA_EGLFS_KMS_CONFIG=/piejam/eglfs.json

    /usr/bin/piejam_app
fi

/sbin/halt
